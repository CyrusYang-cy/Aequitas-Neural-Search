# Solr Configurations
The solrconfiguration mainly depends on two files: [solorconfig.xml](#solrconfigxml) and [solr.xml](#solrxml)

## solrconfig.xml
1. The [solrconfig.xml](configsets/_default/conf/solrconfig.xml) file is the configuration file with the most parameters affecting Solr itself. More info [here](https://solr.apache.org/guide/solr/latest/configuration-guide/configuring-solrconfig-xml.html)
2. In solrconfig.xml, you configure important features:
- *request handlers*, which process the requests to Solr, such as requests to add documents to the index or requests to return results for a query
- *listeners*, processes that "listen" for particular query-related events; listeners can be used to trigger the execution of special code, such as invoking some common queries to warm-up caches
- *the Request Dispatcher* for managing HTTP communications
- *the Admin Web interface*
- parameters related to *replication and duplication* when not running in SolrCloud mode

### Request handler
> A request handler processes requests coming to Solr. These might be query requests, index update requests or specialized interactions such as Ping. See more [here](https://solr.apache.org/guide/solr/latest/configuration-guide/requesthandlers-searchcomponents.html)
Solr provides several built-in request handlers for common operations, including:
1. *Search handlers*: These handlers process search queries and return matching documents. Some examples are:
- [/select](configsets/_default/conf/solrconfig.xml#L734): The default search handler that handles query requests using a variety of query parsers (e.g., Lucene, DisMax, eDisMax) and returns search results.
    - By default, only the "q" parameter would be used for keyword search.
    - However, if the request handler has more default parameters defined, those will be used with any query we send to that request handler unless they are overridden by the client (or user) in the query itself.
    - By default, /select is a request handler that handles query requests and one expected by most examples and tools.
- [/query](configsets/_default/conf/solrconfig.xml#L742): The /query request handler is essentially an alternative name for the /select search handler. They both serve the same purpose: to process search queries and return matching documents.
    - By default, Solr uses the /select handler for search queries, but you can configure a custom request handler with the name /query or any other name
    - To use the /query handler in your queries, simply replace the /select part of the request URL with /query, for example: 
```bash
http://localhost:8983/solr/<your_core_or_collection>/query?q=<your_search_terms>
```
2. *Update handlers*: These handlers handle document indexing, updating, and deleting operations. Some examples are:
- [/update](configsets/_default/conf/solrconfig.xml#L251): it is an implicit request handler that handles index updates (i.e., sending new documents to the index)
3. *Administrative handlers*: These handlers manage various administrative tasks related to Solr. Some examples are:
- /admin/ping: A handler that checks the health and availability of a Solr core or collection.
- /admin/segments: A handler that provides information about the segments in a Solr index.
4. *Custom handler*; It is possible to create custom request handler. 
- You can customize their behavior by specifying various settings, such as caching, timeouts, or default parameters.
- Additionally, you can create custom request handlers by extending Solr's base classes and implementing the desired functionality.
- if you create your own request handler, you should make sure it includes the ability to handle nested paths if you want to use them with your custom request handler.
- If a request handler is not expected to be used very often, it can be marked with [startup="lazy"](configsets/_default/conf/solrconfig.xml#L822) to avoid loading until needed.

### Listener
> "listener" generally refers to components that are notified when certain events occur within the search engine, such as the completion of a search request or an update operation. See more [here](https://solr.apache.org/guide/7_1/solrcloud-autoscaling-listeners.html#:~:text=Trigger%20Listeners%20allow%20users%20to,as%20they%20are%20being%20processed)
- see example [here](configsets/_default/conf/solrconfig.xml#L533)
- inside listener configuration , you can specify what processing *stages* are of interest, and when an event enters this processing stage the listener will be notified. 
    - *started* - when an event has been generated by a trigger and its processing is starting.
    - *aborted* - when event was being processed while the source trigger closed.
    - *before_action* - when a triggeraction is about to be invoked. action name and the current actioncontext are passed to the listener.
    - *after_action* - after a triggeraction has been successfully invoked. action name, actioncontext and the list of action names invoked so far are passed to the listener.
    - *failed* - when event processing failed (or when a triggeraction failed)
    - *succeeded* - when event processing completes successfully

---
| configuration properties | Definition |
|-----------------|-----------------|
| *name* (string, required) | A unique listener configuration name. |
| *trigger* (string, required) | The name of an existing trigger configuration.|
| *class* (string, required) | A listener implementation class name.|
| *stage* (list of strings, optional, ignored case) | A list of processing stages that this listener should be notified. Default is empty list.
| *beforeAction* (list of strings, optional) | A list of action names (as defined in trigger configuration) before which the listener will be notified. Default is empty list.|
| *afterAction* (list of strings, optional) |  A list of action names after which the listener will be notified. Default is empty list.|
---

### Request Dispatcher
> The requestDispatcher element of solrconfig.xml controls the way the Solr HTTP RequestDispatcher implementation responds to requests. See more [here](https://solr.apache.org/guide/6_6/requestdispatcher-in-solrconfig.html)
- see example [here](configsets/_default/conf/solrconfig.xml#L627)
- It includes following elements
1. handleSelect Element
- This attribute can be set to one of two values, either "true" or "false". It governs how Solr responds to requests such as /select?qt=XXX.
2. requestParsers Element
- The <requestParsers> sub-element controls values related to parsing requests. This is an empty XML element that doesnâ€™t have any content, only attributes.
3. httpCaching Element
- This element controls caching of HTTP responses as defined by the W3C HTTP specifications.

### Lib Directives in SolrConfig
> Both plugin and resource file paths are configurable via <lib/> directives in solrconfig.xml. When a directive matches a directory, then resources can be resolved from it. See more [here](https://solr.apache.org/guide/solr/latest/configuration-guide/libs.html#lib-directives-in-solrconfig)
- see example [here](configsets/_default/conf/solrconfig.xml#L75) which includes a lib directory should be included that contains JAR files for Learning to Rank (LTR) functionality. 
  - The [module directory](../../modules) includes various Solr modules 
    - To [install a module](https://solr.apache.org/guide/solr/latest/configuration-guide/solr-modules.html) you can edit the [solr.in.sh](../../bin/solr.in.sh#L284)
  - that provide additional functionality to Solr, such as plugins, components, and analysis tools (ranked by relevance in this project) :
    - [analysis-extras](../../modules/analysis-extras/README.md) provides  includes additional text analysis tools and filters 
    - [extraction](../../modules/extraction/README.md) provides a means for extracting and indexing content contained in "rich" documents, such PDF
    - [ltr](../../modules/ltr/README.md) provides a machine learning-based functionality for improving search relevance
    - [scripting](../../modules/scripting/README.md) provides a mechanism for running custom scripts and code within Solr, allowing users to extend and customize Solr's functionality.
    - [s3-repository](../../modules/s3-repository/README.md) provides a mechanism for storing Solr indexes in Amazon S3, a cloud-based object storage service provided by Amazon Web Services (AWS).
    - [analytics](../../modules/analytics) provides advanced analytics and reporting capabilities
    - [clustering](../../modules/clustering/README.md) is used to group similar search results together into clusters
as Microsoft Word, Adobe PDF, etc. 
    - [gcs-repository](../../modules/gcs-repository/README.md) is a backup repository implementation that uses Google Cloud Storage (GCS).
    - [hadoop-auth](../../modules/hadoop-auth/REAME.md) allows Solr to use Hadoop's authentication and authorization mechanisms for user authentication and access control.
    - [hdfs](../../modules/hdfs/README.md) implements the support for Hadoop Distributed File System in Apache Solr. 
    - [jaegertracer-configurator](../../modules/jaegertracer-configurator/README.md) provides a way for you to expose Solr's tracing to Jaeger.
    - [jwt-auth](../../modules/jwt-auth/README.md). JWTs are a type of JSON-based token that can be used to authenticate and authorize requests to Solr's APIs.
    - [langid](../../modules/langid/README.md) allows Solr to automatically detect the language of text data.
    - [sql](../../modules/sql/README.md) provides a SQL-based interface for querying Solr data using the standard SQL language.
- There are few worth-noting things about lib directives [here](configsets/_default/conf/solrconfig.xml#L40)

#### Scripting Plugin
##### Update Request Processor
> Every update request received by Solr is run through a chain of plugins known as Update Request Processors, or URPs See more [here](https://solr.apache.org/guide/solr/latest/configuration-guide/update-request-processors.html)
1. URPs could be describled as [abstract class UpdateRequestProcessor](https://solr.apache.org/docs/9_2_0/core/org/apache/solr/update/processor/UpdateRequestProcessor.html)
2. Every URP must have a corresponding factory class which extends [UpdateRequestProcessorFacotyr](https://solr.apache.org/docs/9_2_0/core/org/apache/solr/update/processor/UpdateRequestProcessorFactory.html) which is used by Solr to create a new instance of this plugin
3. When an update request is received by Solr, it looks up the update chain to be used for this request. 
- a new isntance of each URP specified in the chain is created using the corresponding factory
- the update request is then parsed into corresponding [UpdateCommand objects](https://solr.apache.org/docs/9_2_0/core/org/apache/solr/update/UpdateCommand.html)  which are run through the chain. 
4. Each URP instance is resposible for involking the next plugin in the chain. 
- It can choose to short circuit the chain by not invoking the next plugin in the chain
- and even abort further processing by throwing an exception

###### Constructing URPs
1. Default update request processor chain
- in case no update processor chains are configured in `solrcongif.xml`, Solr will automatically create a default update processor chain  which will be used for all update requests. The default update processor chain consists of the following processors (in order):
- [LogUpdateProcessorFactory](configsets/_default/conf/solrconfig.xml#L1028): tracks the commands processed during this request and logs them
- [DistributedUpdateProcessorFactory](configsets/_default/conf/solrconfig.xml#L1029): Responsible for distributing update requests to the right node e.g., routing requests to the leader of the right shard and distributing updates from the leader to each replica. This processor is activated only in SolrCloud mode.
- [RunUpdateProcessorFactory](configsets/_default/conf/solrconfig.xml#L1030): Executes teh update using internal Solr APIs
    - It is usually the last update processor in any custom chain.
2. Custom URP chain
- This chain is an example of how Solr can be configured to perform de-duplication of documents by calculating a signature using the value of name, features, cat fields which is then used as the "id" field.
- See [here](configsets/_default/conf/solrconfig.xml#L1034) for example
3. Update request processors can also be configured independent of a chain in solrconfig.xml.
```xml
<updateProcessor class="solr.processor.SignatureUpdateProcessorFactory" name="signature">
  <bool name="enabled">true</bool>
  <str name="signatureField">id</str>
  <bool name="overwriteDupes">false</bool>
  <str name="fields">name,features,cat</str>
  <str name="signatureClass">solr.processor.Lookup3Signature</str>
</updateProcessor>
<updateProcessor class="solr.RemoveBlankFieldUpdateProcessorFactory" name="remove_blanks"/>
```
- Once the above has been specified in solrconfig.xml, we can be refer to them in update request processor chains in solrconfig.xml as follows:
```xml
<updateProcessorChain name="custom" processor="remove_blanks,signature">
  <processor class="solr.RunUpdateProcessorFactory" />
</updateProcessorChain>
```
4. The `update.chain` parameter can be used in any update request to choose a custom chain which has been configured in solrconfig.xml. For example, in order to choose the "dedupe" chain described in a previous section, one can issue the following request:
```bash
curl "http://localhost:8983/solr/gettingstarted/update/json?update.chain=dedupe&commit=true" -H 'Content-type: application/json' -d '
[
  {
    "name" : "The Lightning Thief",
    "features" : "This is just a test",
    "cat" : ["book","hardcover"]
  },
  {
    "name" : "The Lightning Thief",
    "features" : "This is just a test",
    "cat" : ["book","hardcover"]
  }
]'
```
5. Configuring a Custom Chain as a Default
- This can be done by adding either "update.chain" or "processor" and "post-processor" as default parameter for a given path which can be done either via [InitParams](configsets/_default/conf/solrconfig.xml#L751)
```xml
<initParams path="/update/**">
  <lst name="defaults">
    <str name="update.chain">add-unknown-fields-to-the-schema</str>
  </lst>
</initParams>
```
-  or by adding them in a ["defaults"](configsets/_default/conf/solrconfig.xml#L823) section which is supported by all request handlers.
```xml
<requestHandler name="/update/extract" startup="lazy" class="solr.extraction.ExtractingRequestHandler" >
  <lst name="defaults">
    <str name="update.chain">add-unknown-fields-to-the-schema</str>
  </lst>
</requestHandler>
```
6. [Update Request Processor Factories](https://solr.apache.org/guide/solr/latest/configuration-guide/update-request-processors.html)

##### Script Update Processor
1. [ScriptUpdateProcessorFactory](https://solr.apache.org/guide/solr/latest/configuration-guide/script-update-processor.html) allows Java scripting engines to be used during Solr document update processing, allowing dramatic flexibility in expressing custom document processing logic before being indexed.
- It is implemented as an UpdateProcessor to be placed in an UpdateChain.


## solr.xml
> See more [here](https://solr.apache.org/guide/solr/latest/configuration-guide/configuring-solr-xml.html) for configuring solr.xml
> See more [here](https://solr.apache.org/guide/solr-cores-and-solr-xml.html) for core.property
1. This is the primary configuration file Solr looks for when starting;
it specifies high-level configuration options that apply to all
of your Solr cores, such as cluster-wide SolrCloud settings like
the ZooKeeper client timeout.
2. In addition, you can also declare Solr cores in this file, however
it is recommended to just use automatic core discovery instead of
listing cores in [solr.xml](solr.xml).
3. If no solr.xml file is found, then Solr assumes that there should be
a single SolrCore named "collection1" and that the "Instance Directory"
for collection1 should be the same as the Solr Home Directory.

### Individual SolrCore Instance Directories
Although solr.xml can be configured to look for SolrCore Instance Directories
in any path, simple sub-directories of the Solr Home Dir using relative paths
are common for many installations.

### Core Discovery
> See more [here](https://solr.apache.org/guide/solr/latest/configuration-guide/core-discovery.html)
During startup, Solr will scan sub-directories of Solr home looking for
a specific file named core.properties. If core.properties is found in a
sub-directory (at any depth), Solr will initialize a core using the properties
defined in core.properties. 

### A Shared 'lib' Directory
Although solr.xml can be configured with an optional "sharedLib" attribute
that can point to any path, it is common to use a "./lib" sub-directory of the
Solr Home Directory.

### ZooKeeper Files
> See more [here](https://solr.apache.org/guide/solrcloud.html)
When using SolrCloud using the embedded ZooKeeper option for Solr, it is
common to have a "zoo.cfg" file and "zoo_data" directories in the Solr Home
Directory.
